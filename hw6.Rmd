---
title: "hw6"
output: github_document
date: "2025-12-02"
---

```{r setup, include=FALSE}
library(readr)
library(tidyverse)
library(broom)
library(janitor)
library(modelr)
homi <- read_csv("homicide-data.csv")

```

## Q1 
```{r}
homi <- homi %>%
  mutate(
    city_state = paste(city, state, sep = ", "),
    solved = if_else(str_detect(disposition, "Closed"), 1, 0)
  ) %>%
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ",
                            "Kansas City, MO", "Tulsa, AL")) %>%
  filter(victim_race %in% c("White", "Black")) %>%
  mutate(
    victim_age = na_if(victim_age, "Unknown"),
    victim_age = as.numeric(victim_age)
  )
```

```{r}
# 1. Filter to Baltimore
balt <- homi %>%
  filter(city_state == "Baltimore, MD")

# 2. Fit logistic regression and save model object
fit_balt <- glm(
  solved ~ victim_age + victim_race + victim_sex,
  data = balt,
  family = binomial()
)

# 3. Tidy results with ORs and 95% CI
results_balt <- broom::tidy(
  fit_balt,
  exponentiate = TRUE,
  conf.int = TRUE
)

# 4. Display OR for all predictors (or filter)
results_balt %>%
  filter(term == "victim_sexMale") %>%   
  select(term, OR = estimate, conf.low, conf.high, p.value) %>%
  knitr::kable(digits = 3)
```

```{r}

city_results <- homi %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ glm(
      solved ~ victim_age + victim_race + victim_sex,
      data = .x,
      family = binomial()
    )),
    tidy_fit = map(fit, ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE))
  ) %>%
  unnest(tidy_fit) %>%
  filter(str_detect(term, "victim_sexMale")) %>%
  select(city_state, term, OR = estimate, conf.low, conf.high, p.value)

city_results
```

```{r}
city_results %>%
  mutate(city_state = fct_reorder(city_state, OR)) %>%   # order by OR
  ggplot(aes(x = OR, y = city_state)) +
  geom_point(size = 2, color = "darkblue") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, color = "gray40") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
  labs(
    title = "Adjusted Odds Ratios (Male vs Female Victims) by City",
    x = "Adjusted Odds Ratio (Male vs Female)",
    y = "City"
  ) +
  theme_minimal()
```

Compared to female, males on average are less likely to have their cases solved. As from the plot, we can see most cities' odds ratios fall under 1. 

## Q2
```{r}
library(p8105.datasets)
data("weather_df")
```


```{r}
we_df <- weather_df
fit <- lm(tmax ~ tmin + prcp, data = we_df)
```

create a function 
```{r}
boot_fun <- function(df) {
  
  # resample rows with replacement
  boot_df <- df %>% sample_frac(replace = TRUE)
  
  # fit model
  fit_boot <- lm(tmax ~ tmin + prcp, data = boot_df)
  
  # extract R^2 from glance()
  r2 <- glance(fit_boot)$r.squared
  
  # extract coefficients
  coefs <- tidy(fit_boot)
  
  b1 <- coefs$estimate[coefs$term == "tmin"]
  b2 <- coefs$estimate[coefs$term == "prcp"]
  
  ratio <- b1 / b2
  
  # return a tibble
  tibble(r2 = r2, ratio = ratio)
}
```

```{r}
set.seed(4)
boot_res <- map_dfr(1:5000, ~ boot_fun(weather_df))
```

R^2 plot

```{r}
boot_res %>%
  ggplot(aes(x = r2)) +
  geom_density(fill = "skyblue", alpha = 0.5) +
  labs(title = "Bootstrap Distribution of R²") +
  theme_minimal()

boot_res %>%
  ggplot(aes(x = ratio)) +
  geom_density(fill = "orange", alpha = 0.5) +
  labs(title = "Bootstrap Distribution of β1 / β2") +
  theme_minimal()
```

```{r}
r1 <- quantile(boot_res$r2, c(0.025, 0.975))

r2 <- quantile(boot_res$ratio, c(0.025, 0.975))
```

The 95% bootstrap confidence interval for \(r^2\) is `r round(r1[1], 3)` to `r round(r1[2], 3)`.

The 95% bootstrap confidence interval for \(\hat\beta_1 / \hat\beta_2\) is `r round(r2[1], 3)` to `r round(r2[2], 3)`.

## Q3
```{r}
bw <- read_csv("birthweight.csv") %>% clean_names() %>%              # clean variable names
  mutate(
    # Convert baby sex to factor
    babysex = factor(babysex,
                     levels = c(1, 2),
                     labels = c("male", "female")),
    
    # Convert malformation indicator to logical
    malform = factor(malform,
                     levels = c(0, 1),
                     labels = c("absent", "present")),
    
    # Convert parental race to factor
    frace = factor(frace,
                   levels = c(1, 2, 3, 4, 8, 9),
                   labels = c("white", "black", "asian", "puerto_rican", 
                              "other", "unknown")),
    
    mrace = factor(mrace,
                   levels = c(1, 2, 3, 4, 8),
                   labels = c("white", "black", "asian", "puerto_rican", "other")),
    
    # Ensure variables that are meant to be numeric are treated as numeric
    across(c(bhead, blength, bwt, delwt, fincome, gaweeks, menarche, 
             mheight, momage, parity, pnumlbw, pnumsga, ppbmi, ppwt, 
             smoken, wtgain),
           as.numeric)
  )

```

```{r}
bw_1 <- bw %>%
  mutate(
    babysex = factor(babysex),    # ensure babysex is factor
    fincome = as.numeric(fincome),
    gaweeks = as.numeric(gaweeks)
  )

fit1 <- lm(bwt ~ babysex + fincome + gaweeks, data = bw_1)
fit1

bw_1 %>%
  add_predictions(fit1) %>%
  add_residuals(fit1)%>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(
    x = "Fitted Birthweight",
    y = "Residuals",
    title = "Residuals vs Fitted Values: Model 1"
  ) +
  theme_minimal()

```

This model is based on a combination of biological reasoning and exploratory analysis. Gestational age is one of the strongest determinants of fetal growth, while family income may influence maternal health behaviors and prenatal care access. Baby’s sex is known to be associated with small but systematic differences in average birthweight.

cross_validation
```{r}
set.seed(2)

cv_df <- 
  crossv_mc(bw, n = 150) %>%   
  mutate(
    train = map(train, as_tibble),
    test  = map(test, as_tibble)
  )

cv_models <- cv_df %>%
  mutate(
    # Model 1
    mod1 = map(train, ~ lm(bwt ~ babysex + fincome + gaweeks, data = .x)),
    
    # Model 2
    mod2 = map(train, ~ lm(bwt ~ blength + gaweeks, data = .x)),
    
    # Model 3
    mod3 = map(train, ~ lm(bwt ~ bhead * blength * babysex, data = .x))
  )

cv_results <- cv_models %>%
  mutate(
    rmse_mod1 = map2_dbl(mod1, test, ~ rmse(.x, .y)),
    rmse_mod2 = map2_dbl(mod2, test, ~ rmse(.x, .y)),
    rmse_mod3 = map2_dbl(mod3, test, ~ rmse(.x, .y))
  )

cv_results %>%
  pivot_longer(
    starts_with("rmse"),
    names_to = "model",
    values_to = "rmse"
  ) %>%
  mutate(model = fct_inorder(model)) %>%
  group_by(model) %>%
  summarise(mean_rmse = mean(rmse)) %>%
  knitr::kable(digits = 2)

```


